name: Подготовка релиза и публикация в хабе 

on:
    release:
        types: [published, edited]

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest]
        oscript_version: ['1.2.0']
    steps:
      - uses: actions/checkout@v2
      - name: Извлечение версии сборки
        shell: bash
        run: echo "##[set-output name=version;]`cat packagedef | grep ".Версия(" | sed 's|[^"]*"||' | sed -r 's/".+//'`"
        id: extract_version
      - name: Установка OneScript
        uses: otymko/setup-onescript@v1.0
        with:
          version: ${{ matrix.oscript_version }}
      - name: Установка зависимостей
        run: |
          opm install opm
          opm install xml-parser@0.1.1 && opm install 1connector@2.1.3
      - name: Сборка пакета
        run: opm build
      - name: Заливка артифактов
        uses: actions/upload-artifact@v2
        with:
          name: crs-api.zip
          path: ./crs-api-*.ospx
      - name: Заливка в релиз
        uses: AButler/upload-release-assets@v1.0
        with:
          files: ./crs-api-*.ospx
          repo-token: ${{ secrets.GITHUB_TOKEN }}
      - name: Публикация в hub.oscript.io
        run: opm push -f crs-api$-{{ steps.extract_version.outputs.version }}.ospx --token "$TOKEN_FOR_HUB" -c stable
        env:
          TOKEN_FOR_HUB: ${{ secrets.HUB_TOKEN }}